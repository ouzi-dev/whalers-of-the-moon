REPO := quay.io/ouzi/toolbox
TAG ?= 0.2.1

GO_BUILDER_TAG ?= 1.18.5
HELM_VERSION ?= v3.9.3
KUBECTL_VERSION ?= v1.24.3
AWS_CLI_VERSION ?= 1.25.54
TF_VERSION ?= 1.2.7
GOTPL_VERSION ?= v0.7
CREDSTASH_VERSION ?= 1.16.1
GCLOUD_VERSION ?= 398.0.0
YQ_VERSION ?= 3.4.0
KUBEVAL_VERSION ?= v0.16.1

.PHONY: build push

build-local:
	docker build \
		--build-arg GO_BUILDER_TAG=$(GO_BUILDER_TAG) \
		--build-arg HELM_VERSION=$(HELM_VERSION) \
		--build-arg KUBECTL_VERSION=$(KUBECTL_VERSION) \
		--build-arg AWS_CLI_VERSION=$(AWS_CLI_VERSION) \
		--build-arg TF_VERSION=$(TF_VERSION) \
		--build-arg GOTPL_VERSION=$(GOTPL_VERSION) \
		--build-arg CREDSTASH_VERSION=$(CREDSTASH_VERSION) \
		--build-arg GCLOUD_VERSION=$(GCLOUD_VERSION) \
		--build-arg YQ_VERSION=$(YQ_VERSION) \
		--build-arg KUBEVAL_VERSION=$(KUBEVAL_VERSION) \
		-t $(REPO):$(TAG) -f ./Dockerfile .

build:
	@gcloud builds submit --config cloudbuild-build.yaml \
				--substitutions=_TAG_VERSION=$(TAG),_QUAY_REPO=$(REPO)\
,_HELM_VERSION="$(HELM_VERSION)"\
,_GO_BUILDER_TAG="$(GO_BUILDER_TAG)"\
,_KUBECTL_VERSION="$(KUBECTL_VERSION)"\
,_AWS_CLI_VERSION="$(AWS_CLI_VERSION)"\
,_TF_VERSION="$(TF_VERSION)"\
,_GOTPL_VERSION="$(GOTPL_VERSION)"\
,_CREDSTASH_VERSION="$(CREDSTASH_VERSION)"\
,_GCLOUD_VERSION="$(GCLOUD_VERSION)"\
,_YQ_VERSION="$(YQ_VERSION)"\
,_KUBEVAL_VERSION="$(KUBEVAL_VERSION)"

push:
	@gcloud builds submit --config cloudbuild-push.yaml \
				--substitutions=_TAG_VERSION=$(TAG),_QUAY_REPO=$(REPO)\
,_HELM_VERSION="$(HELM_VERSION)"\
,_GO_BUILDER_TAG="$(GO_BUILDER_TAG)"\
,_KUBECTL_VERSION="$(KUBECTL_VERSION)"\
,_AWS_CLI_VERSION="$(AWS_CLI_VERSION)"\
,_TF_VERSION="$(TF_VERSION)"\
,_GOTPL_VERSION="$(GOTPL_VERSION)"\
,_CREDSTASH_VERSION="$(CREDSTASH_VERSION)"\
,_GCLOUD_VERSION="$(GCLOUD_VERSION)"\
,_YQ_VERSION="$(YQ_VERSION)"\
,_KUBEVAL_VERSION="$(KUBEVAL_VERSION)"